<!DOCTYPE html>
<!-- Offirmo's loading iframe v0.0.3 2020/04/17 -->
<html lang="en" xml:lang="en" class="o⋄top-container">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="Content-Language" content="en" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<title>Loading…</title>

	<!-- CUSTOM BEGINS favicon and webmanifest -->
	<!-- thank you https://realfavicongenerator.net/ -->
	<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png?v=yyapgPk479">
	<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png?v=yyapgPk479">
	<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png?v=yyapgPk479">
	<link rel="manifest" href="favicons/site.webmanifest?v=yyapgPk479">
	<link rel="mask-icon" href="favicons/safari-pinned-tab.svg?v=yyapgPk479" color="#543d46">
	<link rel="shortcut icon" href="favicons/favicon.ico?v=yyapgPk479">
	<meta name="msapplication-TileColor" content="#543d46">
	<meta name="msapplication-config" content="favicons/browserconfig.xml?v=yyapgPk479">
	<meta name="theme-color" content="#543d46">
	<!-- CUSTOM ENDS -->

	<style type="text/css">
		:root {
			--bg: black;
			--fg: hsl(0, 0%, 98%);
			--font: -apple-system, BlinkMacSystemFont, "lucida grande", roboto, noto, ubuntu, sans-serif;
		}

		html, body {
			width: 100%;
			margin: 0;
			padding: 0;
			background-color: var(--bg);
			color: var(--fg);
			font-family: var(--font);
		}

		iframe {
			position: absolute;
			width: 100%;
			border: 0;
		}

		.o⋄top-container {
			display: flex;
			flex-direction: column;
			height: 100%;
		}

		.blinking{
			animation: blinkingText 1.2s infinite ease-in-out;
		}
		@keyframes blinkingText{
			0% {  color: inherit; }
			33% { color: transparent; }
		}

		.progressive {
			display: none;
		}

		#loader {
			position: absolute;
			width: 100%;
			background-color: var(--bg);
		}
		#loader > div {
			margin: auto;
			text-align: center;
			font-size: x-large;
		}
	</style>
</head>

<body class="o⋄top-container o⋄body⁚full-page">
<noscript>You need to enable JavaScript to run this app.</noscript>

<!-- the actual app -->
<iframe class="o⋄top-container progressive"
		  importance="high"
		  loading="eager"
		  scrolling="no"
>
	<p>Error. Your app should be here.</p>
</iframe>

<!-- the loader (on top) -->
<div id="loader" class="o⋄top-container">
	<div>
		<p id="legend"></p>
		<p class="blinking">Loading…</p>
		<label class="progressive">
			<progress></progress>
			0%
		</label>
	</div>
</div>

</body>

<script>
	user_settings = {}

	function get_current_path() {
		return window.location.pathname.endsWith('/index.html')
			? window.location.pathname.slice(0, -11)
			: window.location.pathname.endsWith('/')
				? window.location.pathname.slice(0, -1)
				: window.location.pathname
	}
</script>

<!-- CUSTOM BEGINS early code -->
<script>
	// I absolutely don't understand this bug but nevermind, easy to fix
	if (document.URL === 'https://www.online-adventur.es/A-apps/the-boring-rpg') {
		console.warn('strange non-/ case, redirecting...')
		window.location = document.URL + '/'
	}
	if (document.URL === 'http://localhost:1981/A-apps/the-boring-rpg/client-browser/src/index.html') {
		user_settings.app_url = '../.parcel/index-2.html'
	}
</script>
<!-- CUSTOM ENDS -->

<script type="module">
	// TODO move to demo
	if (document.URL.startsWith('http://localhost:1981/5-incubator/active/iframe-loading/src/index.html')) {
		user_settings.app_url = '../doc/demo/index-2.html'
	}

	/*
		console.log(`[IL] hello m1`)
		window.onload = (e) => console.log(`[IL] GlobalEventHandlers.onload`, e)
		window.frames[0].onload = (e) => console.log(`[IL] GlobalEventHandlers.onload 2`, e)
	*/
	window._id = 'loading iframe' // test TODO clean

	/////////////////////

	const DEFAULT_RSRC_ID = 'overall'
	const LS_KEY_CONFIG_FROM_PREVIOUS_RUN = `XOF.loading-iframe.config_cache.url(${user_settings.app_url})`

	/////////////////////

	let state = {
		settings: {
			// flat for easy merging
			bg_color: 'black',
			fg_color: 'hsl(0, 0%, 98%)',
			// TODO font
			app_url: get_current_path() + '/index-2.html', // TODO pass queryparams
			legend: undefined,
			expected_rsrc_count: 1,
			...user_settings,
		},

		is_rsrc_loaded: {
			[DEFAULT_RSRC_ID]: false,
		},

		error: null,
	}

	/////////////////////

	function get_load_infos(state) {
		const rsrc_keys = Object.keys(state.is_rsrc_loaded)
		//console.log(rsrc_keys)
		const current_loaded_count = rsrc_keys.reduce((acc, k) => {
			//console.log(k, state.is_rsrc_loaded[k])
			return acc + (state.is_rsrc_loaded[k] ? 1 : 0)
		}, 0)

		const current_count = rsrc_keys.length
		const expected_full_count = Math.max(state.settings.expected_rsrc_count, current_count)
		return {
			expected_full_count,
			current_count,
			current_loaded_count,
			is_loaded: current_loaded_count === expected_full_count,
		}
	}

	/////////////////////

	function on_error(state, error) {
		console.error('on error', { error })
		state = {
			...state,
			error,
		}
		return state
	}

	function update_settings(state, partial) {
		state = {
			...state,
			settings: {
				...state.settings,
				...partial,
			},
		}
		return state
	}

	function on_rsrc_loaded(state, id = DEFAULT_RSRC_ID) {
		//console.log(`[IL] on_rsrc_loaded`, id)
		state = {
			...state,
			is_rsrc_loaded: {
				...state.is_rsrc_loaded,
				[id]: true,
			},
		}
		return state
	}

	/////////////////////


	window.XOFF = {
		top_frame: window.parent,
		flags: {},
		...window.parent.XOFF,
	}
	if (window.XOFF.loader) {
		console.error('Error! iframe-loading recursion!')
		// TODO immediately hide our own loader
	} else {
		window.XOFF.loader = {
			configure({legend, expected_rsrc_count, bg_color, fg_color, ...others} = {}) {
				if (Object.keys(others).length > 0) console.error(`[IL] configure_loader() unknown params:`, others)

				try {
					localStorage.setItem(LS_KEY_CONFIG_FROM_PREVIOUS_RUN, JSON.stringify({
						legend,
						expected_rsrc_count,
						bg_color,
						fg_color
					}))
				} catch {
				}

				legend = legend || state.settings.legend
				expected_rsrc_count = expected_rsrc_count || state.settings.expected_rsrc_count
				bg_color = bg_color || state.settings.bg_color
				fg_color = fg_color || state.settings.fg_color

				state = update_settings(state, {
					legend,
					expected_rsrc_count,
					bg_color,
					fg_color,
				})
				render(state, 'configure')
			},
			on_rsrc_loaded(id) {
				state = on_rsrc_loaded(state, id)
				render(state, 'on_rsrc_loaded')
			},
		}
	}

	// TODO allow passing custom favicon

	/////////////////////

	function render(state, caller) {
		const elt_iframe = document.getElementsByTagName('iframe')[0]
		const elt_loader = document.getElementById('loader')
		const elt_legend = document.getElementById('legend')
		const elt_progress = document.getElementsByTagName('progress')[0]
		const elt_progress_area = document.getElementsByTagName('label')[0]
		const sub_frame_window = window.frames[0]

		const load_infos = get_load_infos(state)

		console.log(`[IL] rendering…`, {
			caller,
			state,
			load_infos,
			//elt_iframe,
			//elt_legend,
			//sub_frame: sub_frame_window,
		})

		// TODO improve error handling
		if (load_infos.is_loaded || state.error) {
			window.document.title = sub_frame_window.document.title

			if (elt_iframe.style.display !== 'block') {
				// transition
				//console.log('!!! LOADED !!!')
				elt_iframe.style.display = 'block'
				elt_progress_area.display = 'none'
				elt_loader.style.pointerEvents = 'none'
				// https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API/Using_the_Web_Animations_API
				elt_loader
					.animate(
						[
							{ opacity: 1 },
							{ opacity: 0 },
						], {
							duration: 700,
							easing: 'ease-out',
							fill: 'forwards',
						}
					)
					.finished.then(() => {
					// for easier inspection. Really needed?
					elt_loader.style.display = 'none'
				})

				if (state.error) {
					if (!confirm('Load timeout. Does it look OK? (If not, I’ll try reloading.)'))
						window.location.reload()
				}
			}
			return
		}

		if (!elt_iframe.src) {
			// TODO pass query params
			elt_iframe.src = state.settings.app_url
		}

		if (state.settings.legend) {
			elt_legend.innerText = state.settings.legend
		}

		document.documentElement.style.setProperty(
			'--fg',
			state.settings.fg_color
		)
		document.documentElement.style.setProperty(
			'--bg',
			state.settings.bg_color
		)

		window.document.title = sub_frame_window.document.title || state.settings.legend || ''
	}
	render(state, 'initial')

	try {
		// TODO cache according to the app_url!!
		const cached_config = JSON.parse(localStorage.getItem(LS_KEY_CONFIG_FROM_PREVIOUS_RUN))
		window.configure_loader(cached_config)
	} catch {}

	// TODO re-armable retry / give up timeout on activity
	setTimeout(() => {
		let additional_wait_time_s =
			(!get_load_infos(state).is_loaded && !state.settings.legend)
				? 10
				: 20

		setTimeout(() => {
			if (!get_load_infos(state).is_loaded) {
				state = on_error(state, new Error('Timeout waiting for iframe load!'))
				render(state)
			}
		}, additional_wait_time_s * 1000)
	}, 10 * 1000)

	/////////////////////
</script>

<script type="module">
	// TODO load enhancements
</script>
