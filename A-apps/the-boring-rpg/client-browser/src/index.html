<!DOCTYPE html>
<!-- OTâ‹„GENERATED-FROM-TEMPLATE Offirmo's loading iframe v0.5.0 -->

<html lang="en" xml:lang="en" class="oâ‹„top-container">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="Content-Language" content="en" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

		<!-- OTâ‹„CUSTOM BEGIN meta description -->
		<meta name="description" content="(Browser game) The simplest RPG ever!">
		<meta name="keywords" content="game, incremental, fantasy, rpg">
		<meta name="author" content="Offirmo">
		<meta name="monetization" content="$ilp.uphold.com/26PeD6EzMhYJ">
		<!-- OTâ‹„CUSTOM END meta description -->

		<title>Loadingâ€¦</title>

		<!-- OTâ‹„CUSTOM BEGIN favicons -->
		<!-- https://medium.com/swlh/are-you-using-svg-favicons-yet-a-guide-for-modern-browsers-836a6aace3df -->
		<link rel="icon" href="./favicons/favicon.svg">
		<link rel="apple-touch-icon" href="./favicons/apple-touch-icon-180x180.png">
		<link rel="mask-icon" href="./favicons/safari-mask-icon.svg" color="#543d46">
		<link rel="manifest" href="./site.webmanifest">
		<meta name="theme-color" content="#543d46">
		<!-- https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<!-- OTâ‹„CUSTOM END favicons -->

		<!-- OTâ‹„CUSTOM BEGIN head miscs -->
		<meta name="google-site-verification" content="wf2jOlvKH7eHC1UKByJfrzR55dvhIQI74uzskmYg5MY" />
		<script>
			console.log('I1', { location, isSecureContext: self.isSecureContext })
			// TODO check that! need top frame or not??
			// https://developers.google.com/analytics/devguides/collection/analyticsjs/#alternative_async_tag
			// (modified)
			/*try { window.ga = window.parent.ga } catch {}
			window.ga = window.ga ?? function(){console.log('ga1', arguments);(window.ga.q=window.ga.q||[]).push(arguments)}
			window.ga.l = window.ga.l ?? +new Date*/
			// no further ga commands, we leave that to the sub-frame
		</script>
		<link rel="preconnect" href="https://identity.netlify.com">
		<link rel="preconnect" href="https://www.google-analytics.com">
		<link rel="preconnect" href="https://www.googletagmanager.com">
		<link rel="preconnect" href="https://tlk.io">
		<script>
			// https://developers.google.com/web/fundamentals/primers/service-workers/registration
			/*if ('serviceWorker' in navigator) {
				const options = undefined
				navigator.serviceWorker.register('./service_worker.ts', options)
					.then(
						serviceWorkerRegistration => {
							console.log('Service worker registration succeeded', { serviceWorkerRegistration })
						},
						err => {
							console.error('Service worker registration failed:', { err });
						}
					)
			} else {
				console.warn('Service workers are not supported!');
			}*/
		</script>
		<!-- OTâ‹„CUSTOM END head miscs -->

		<style type="text/css">
			:root {
				--bg: black;
				--fg: hsl(0, 0%, 98%);
				--font: -apple-system, BlinkMacSystemFont, "lucida grande", roboto, noto, ubuntu, sans-serif;
			}

			html, body {
				width: 100%;
				margin: 0;
				padding: 0;
				background-color: var(--bg);
				color: var(--fg);
				font-family: var(--font);
			}

			iframe {
				position: absolute;
				width: 100%;
				border: 0;
				background-color: white; /* bc loader's bg shouldn't bleed into the frame. TODO adapt to dark mode? */
			}

			.oâ‹„top-container {
				display: flex;
				flex-direction: column;
				height: 100%;
			}

			.blinking{
				animation: blinkingText 1.2s infinite ease-in-out;
			}
			@keyframes blinkingText{
				0% {  color: inherit; }
				33% { color: transparent; }
			}

			.progressive {
				display: none;
			}

			#loader {
				position: absolute;
				width: 100%;
				background-color: var(--bg);
			}
			#loader > div {
				margin: auto;
				text-align: center;
				font-size: x-large;
			}

			/* OTâ‹„CUSTOM BEGIN early styles */
			/* OTâ‹„CUSTOM END early styles */
		</style>
	</head>

	<body class="oâ‹„top-container oâ‹„bodyâšfull-page">
		<noscript>You need to enable JavaScript to run this app.</noscript>

		<!-- the actual app, initially hidden -->
		<iframe class="oâ‹„top-container progressive"
			importance="high"
			loading="eager"
			scrolling="no"
		>
			<p>Error. Your app should be here.</p>
			<p>Check your add blocker?</p>
		</iframe>

		<!-- the loader (on top) -->
		<div id="loader" class="oâ‹„top-container">
			<div>
				<p id="legend"></p>
				<p class="blinking">Loadingâ€¦</p>
				<label class="progressive">
					<progress></progress>
					0%
				</label>
			</div>
		</div>
	</body>

	<script>
		window.user_settings = {}
		/* OTâ‹„CUSTOM BEGIN early code */

		// I absolutely don't understand this bug but nevermind, easy to fix
		if (document.URL === 'https://www.online-adventur.es/apps/the-boring-rpg') {
			console.warn('strange non-/ case, redirecting...')
			window.location = document.URL + '/'
		}

		// cordova synchronous detection
		if (location.pathname.endsWith('-cordova.html')) {
			console.info('[I1+] loading cordovaâ€¦')
			// TODO detect the underlying OS? no need for now.
			user_settings.app_queryparams = 'container=cordova'

			// load cordova just for the sake of disabling the loader
			const el = document.createElement('script')
			//el.type = 'text/javascript'
			el.src = 'cordova.js'
			// TODO async
			document.body.appendChild(el)
			document.addEventListener('deviceready', () => {
				console.info('[I1+] cordova deviceready')
			}, false)
		}
		/* OTâ‹„CUSTOM END early code */
	</script>

	<script>
		const PROP = 'oá§loader'
		const DEFAULT_RSRC_ID = 'overall'
		const LIB = 'iframe-loading'
		const logger = (() => {
			try {
				return window._debug.v1.getLogger({name: LIB})
			} catch {}

			if (!!window.localStorage.getItem(`ðŸ› UDA.override.logger.${LIB}.logLevel`))
				return console

			return {
				log() {},
				info() {},
				warn() {},
				error() {},
			}
		})()
		const user_settings = window.user_settings || {}
		logger.log('[IL] startingâ€¦', { location, user_settings })

		/////////////////////

		let state = {
			settings: {
				// flat for easy merging
				bg_color: 'black',
				fg_color: 'hsl(0, 0%, 98%)',
				// TODO font, bg picture etc.
				app_queryparams: [
					user_settings.app_queryparams,
					user_settings.app_url && new URLSearchParams(user_settings.app_url.split('?')[1]).toString(),
					new URLSearchParams(location.search).toString(),
				].filter(s => !!s).join('&'),
				legend: undefined,
				expected_rsrc_count: 1,
				...user_settings,
				// TODO XXX what if no trailing / ?
				app_url: user_settings.app_url // TODO normalize?
					? user_settings.app_url.split('?')[0]
					: './index-2.html',
			},

			is_rsrc_loaded: {
				[DEFAULT_RSRC_ID]: false,
			},

			error: null,
		}
		const LS_KEY_CACHED_CONFIG = `XOF.${LIB}.config_cache.url(${state.settings.app_url})`

		/////////////////////
		// SELECTORS

		function get_load_infos(state) {
			const rsrc_keys = Object.keys(state.is_rsrc_loaded)
			//logger.log(rsrc_keys)
			const current_loaded_count = rsrc_keys.reduce((acc, k) => {
				//logger.log(k, state.is_rsrc_loaded[k])
				return acc + (state.is_rsrc_loaded[k] ? 1 : 0)
			}, 0)

			const current_count = rsrc_keys.length
			const expected_full_count = Math.max(state.settings.expected_rsrc_count, current_count)
			return {
				expected_full_count,
				current_count,
				current_loaded_count,
				is_loaded: current_loaded_count === expected_full_count,
			}
		}

		/////////////////////
		// REDUCERS

		function on_error(state, error) {
			logger.error('[IL] on error', { error, state })
			state = {
				...state,
				error,
			}
			return state
		}

		function update_settings(state, partial) {
			state = {
				...state,
				settings: {
					...state.settings,
					...partial,
				},
			}
			return state
		}

		function on_rsrc_loaded(state, id = DEFAULT_RSRC_ID) {
			//logger.log(`[IL] on_rsrc_loaded`, id)
			state = {
				...state,
				is_rsrc_loaded: {
					...state.is_rsrc_loaded,
					[id]: true,
				},
			}
			return state
		}

		/////////////////////
		// EXPOSE API

		if (window[PROP]) {
			logger.error('[IL] Error! iframe-loading recursion!')
			// TODO immediately hide our own loader
		} else {
			// TODO useful? always postmessage?
			window[PROP] = {
				configure({legend, expected_rsrc_count, bg_color, fg_color, ...others} = {}) {
					if (Object.keys(others).length > 0) logger.error(`[IL] configure_loader() unknown params:`, others)

					try {
						localStorage.setItem(LS_KEY_CACHED_CONFIG, JSON.stringify({
							legend,
							expected_rsrc_count,
							bg_color,
							fg_color
						}))
					} catch {}

					legend = legend || state.settings.legend
					expected_rsrc_count = expected_rsrc_count || state.settings.expected_rsrc_count
					bg_color = bg_color || state.settings.bg_color
					fg_color = fg_color || state.settings.fg_color

					state = update_settings(state, {
						legend,
						expected_rsrc_count,
						bg_color,
						fg_color,
					})
					render(state, 'configure')
				},
				on_rsrc_loaded(id) {
					state = on_rsrc_loaded(state, id)
					render(state, 'on_rsrc_loaded')
				},
			}
		}

		// TODO favicon?

		/////////////////////
		// UX

		function render(state, caller) {
			const elt_iframe = document.getElementsByTagName('iframe')[0]
			const elt_loader = document.getElementById('loader')
			const elt_legend = document.getElementById('legend')
			const elt_progress = document.getElementsByTagName('progress')[0]
			const elt_progress_area = document.getElementsByTagName('label')[0]
			const sub_frame_window = window.frames[0]

			const load_infos = get_load_infos(state)

			logger.log(`[IL] renderingâ€¦`, {
				caller,
				state,
				load_infos,
				//elt_iframe,
				//elt_legend,
				//sub_frame: sub_frame_window,
			})

			if (load_infos.is_loaded || state.error) {
				try { window.document.title = sub_frame_window.document.title } catch {}
				if (elt_iframe.style.display !== 'block') {
					// transition
					logger.log('[IL] !!! LOADED !!!')
					elt_iframe.style.display = 'block'
					elt_progress_area.display = 'none'
					elt_loader.style.pointerEvents = 'none'
					function hide_loader() {
						elt_loader.style.display = 'none'
						// bg back to black to avoid bleeding it on notches on mobile devices (seen on cordova iOs)
						// TODO revisit that, bleeding still looks better than square on notched
						//document.documentElement.style.setProperty('--bg', 'black')
					}
					try {
						// https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API/Using_the_Web_Animations_API
						const animation = elt_loader.animate(
								[
									{opacity: 1},
									{opacity: 0},
								], {
									duration: 700,
									easing: 'ease-out',
									fill: 'forwards',
								}
							)
						// for easier inspection. Not really needed.
						setTimeout(hide_loader, 700)
					} catch (err) {
						logger.warn('[IL] [optional feature] Web Animation API error:', err)
						hide_loader()
					}
					/*if (state.error) {
						// TODO improve error handling
						if (!confirm('Load timeout. Does it look OK? (If not, Iâ€™ll try reloading.)'))
							window.location.reload()
					}*/
				}
				return
			}

			if (!elt_iframe.src) {
				logger.log('[IL] 1st render!')

				const searchParams = new URLSearchParams(state.settings.app_queryparams)
				searchParams.set(PROP, true)
				searchParams.sort()

				elt_iframe.src = state.settings.app_url + '?' + searchParams.toString()

				// just logging, not reliable since the iframe can rewrite them
				elt_iframe.onload = (args) => logger.log(`[IL] iframe loaded`, { args })
				elt_iframe.onerror = (args) => logger.warn(`[IL] iframe something wrong happened`, { args }) // TODO error on this one?

				// cordova support
				// BUT up to the user to load the cordova script if needed!
				// https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-splashscreen/index.html
				document.addEventListener('deviceready', () => {
					if ('splashscreen' in navigator) {
						// take over the loading feature
						setTimeout(() => {
							logger.log('[IL] hiding cordova loader')
							navigator.splashscreen.hide()
						}, 10) // to avoid FOUC
					}
				}, false)

				logger.log(`[IL] Now waiting for the iframe to load "${elt_iframe.src}"`)
			}

			if (state.settings.legend) {
				elt_legend.innerText = state.settings.legend
			}

			document.documentElement.style.setProperty(
				'--fg',
				state.settings.fg_color
			)
			document.documentElement.style.setProperty(
				'--bg',
				state.settings.bg_color
			)

			let sub_frame_title = null
			try { sub_frame_title = sub_frame_window.document.title } catch {}
			window.document.title = sub_frame_title || state.settings.legend || ''
		}

		// trigger initial render

		try {
			const cached_config = JSON.parse(localStorage.getItem(LS_KEY_CACHED_CONFIG))
			if (cached_config) {
				logger.log('[IL] found cached config, restoringâ€¦', { cached_config })
				window[PROP].configure(cached_config)
			}
		} catch (err) {
			logger.warn(err)
		}
		finally {
			render(state, 'initial')
		}

		// TODO re-armable retry / give up timeout on activity
		setTimeout(() => {
			let additional_wait_time_s =
				(!get_load_infos(state).is_loaded && !state.settings.legend)
					? 10
					: 20

			setTimeout(() => {
				if (!get_load_infos(state).is_loaded) {
					state = on_error(state, new Error('Timeout waiting for sub-frame load!'))
					render(state)
				}
			}, additional_wait_time_s * 1000)
		}, 10 * 1000)

		/////////////////////

		// PM listener for cross origin sub-frames
		window.addEventListener('message', ({data, origin, source}) => {
			if (!data[PROP]) return

			logger.log(`[IL] ðŸ“¥ PM ["${prop}"] received`, data[PROP])
			const { method, args } = data[PROP]
			window[PROP][method](...args)
		}, false)

		/////////////////////
	</script>

	<!-- OTâ‹„CUSTOM BEGIN low priority scripts & misc -->
	<script>
		// TODO review this section.
		window.addEventListener('message', ({data, origin, source}) => {
			if (!data.xoff) return

			console.log('[IL+/xoff] ðŸ“¥ PM received', { data, origin, source })
			if (data.xoff.code)
				eval(data.xoff.code)
		}, false)
	</script>
	<!-- OTâ‹„CUSTOM END low priority scripts & misc -->

	<script type="module">
		// TODO progressive enhancements
	</script>
</html>
