<!DOCTYPE html><html lang="en" xml:lang="en" class="o‚ãÑtop-container"><head><meta charset="utf-8"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="Content-Language" content="en"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta name="description" content="(Browser game) The simplest RPG ever!"><meta name="keywords" content="game, incremental, fantasy, rpg"><meta name="author" content="Offirmo"><title>Loading‚Ä¶</title><link rel="icon" href="favicon.20d5d0ac.svg"><link rel="mask-icon" href="safari-mask-icon.f95ea502.svg" color="#000000"><link rel="apple-touch-icon" href="favicon-180x180.c1bd15fc.png"><link rel="manifest" href="site.webmanifest"><meta name="theme-color" content="#543d46"><link rel="preconnect" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://identity.netlify.com"><link rel="preconnect" href="https://tlk.io"><style>:root{--bg:#000;--fg:#fafafa;--font:-apple-system,BlinkMacSystemFont,"lucida grande",roboto,noto,ubuntu,sans-serif}body,html{width:100%;margin:0;padding:0;background-color:var(--bg);color:var(--fg);font-family:var(--font)}iframe{position:absolute;width:100%;border:0;background-color:#fff}.o‚ãÑtop-container{display:flex;flex-direction:column;height:100%}.blinking{animation:blinkingText 1.2s ease-in-out infinite}@keyframes blinkingText{0%{color:inherit}33%{color:transparent}}.progressive{display:none}#loader{position:absolute;width:100%;background-color:var(--bg)}#loader>div{margin:auto;text-align:center;font-size:x-large}</style></head><body class="o‚ãÑtop-container o‚ãÑbody‚Åöfull-page"> <noscript>You need to enable JavaScript to run this app.</noscript>  <iframe class="o‚ãÑtop-container progressive" importance="high" loading="eager" scrolling="no"> <p>Error. Your app should be here.</p> </iframe>  <div id="loader" class="o‚ãÑtop-container"> <div> <p id="legend"></p> <p class="blinking">Loading‚Ä¶</p> <label class="progressive"> <progress></progress> 0% </label> </div> </div> </body><script type="module">

		const DEFAULT_RSRC_ID = 'overall'
		const LOGGER_NAME = 'loading-iframe'
		const logger = (() => {
			try {
				return window._debug.v1.getLogger({name: LOGGER_NAME})
			} catch {}
			if (!!window.localStorage.getItem(`üõ†UDA.override.logger.${LOGGER_NAME}.logLevel`))
				return console

			return {
				log() {},
				warn() {},
				error() {},
			}
		})()
		logger.log('[IL] starting‚Ä¶', { user_settings })

		/////////////////////

		let state = {
			settings: {
				// flat for easy merging
				bg_color: 'black',
				fg_color: 'hsl(0, 0%, 98%)',
				// TODO font, bg picture etc.
				app_url: get_current_path() + '/index-2.html' + window.location.search,
				legend: undefined,
				expected_rsrc_count: 1,
				...user_settings,
			},

			is_rsrc_loaded: {
				[DEFAULT_RSRC_ID]: false,
			},

			error: null,
		}
		const LS_KEY_CACHED_CONFIG = `XOF.loading-iframe.config_cache.url(${state.settings.app_url})`

		/////////////////////

		function get_load_infos(state) {
			const rsrc_keys = Object.keys(state.is_rsrc_loaded)
			//logger.log(rsrc_keys)
			const current_loaded_count = rsrc_keys.reduce((acc, k) => {
				//logger.log(k, state.is_rsrc_loaded[k])
				return acc + (state.is_rsrc_loaded[k] ? 1 : 0)
			}, 0)

			const current_count = rsrc_keys.length
			const expected_full_count = Math.max(state.settings.expected_rsrc_count, current_count)
			return {
				expected_full_count,
				current_count,
				current_loaded_count,
				is_loaded: current_loaded_count === expected_full_count,
			}
		}

		/////////////////////

		function on_error(state, error) {
			logger.error('[IL] on error', { error })
			state = {
				...state,
				error,
			}
			return state
		}

		function update_settings(state, partial) {
			state = {
				...state,
				settings: {
					...state.settings,
					...partial,
				},
			}
			return state
		}

		function on_rsrc_loaded(state, id = DEFAULT_RSRC_ID) {
			//logger.log(`[IL] on_rsrc_loaded`, id)
			state = {
				...state,
				is_rsrc_loaded: {
					...state.is_rsrc_loaded,
					[id]: true,
				},
			}
			return state
		}

		/////////////////////

		if (window.o·êßloader) {
			logger.error('[IL] Error! iframe-loading recursion!')
			// TODO immediately hide our own loader
		} else {
			window.o·êßloader = {
				configure({legend, expected_rsrc_count, bg_color, fg_color, ...others} = {}) {
					if (Object.keys(others).length > 0) logger.error(`[IL] configure_loader() unknown params:`, others)

					try {
						localStorage.setItem(LS_KEY_CACHED_CONFIG, JSON.stringify({
							legend,
							expected_rsrc_count,
							bg_color,
							fg_color
						}))
					} catch {}

					legend = legend || state.settings.legend
					expected_rsrc_count = expected_rsrc_count || state.settings.expected_rsrc_count
					bg_color = bg_color || state.settings.bg_color
					fg_color = fg_color || state.settings.fg_color

					state = update_settings(state, {
						legend,
						expected_rsrc_count,
						bg_color,
						fg_color,
					})
					render(state, 'configure')
				},
				on_rsrc_loaded(id) {
					state = on_rsrc_loaded(state, id)
					render(state, 'on_rsrc_loaded')
				},
			}
		}

		// TODO favicon?

		/////////////////////

		function render(state, caller) {
			const elt_iframe = document.getElementsByTagName('iframe')[0]
			const elt_loader = document.getElementById('loader')
			const elt_legend = document.getElementById('legend')
			const elt_progress = document.getElementsByTagName('progress')[0]
			const elt_progress_area = document.getElementsByTagName('label')[0]
			const sub_frame_window = window.frames[0]

			const load_infos = get_load_infos(state)

			logger.log(`[IL] rendering‚Ä¶`, {
				caller,
				state,
				load_infos,
				//elt_iframe,
				//elt_legend,
				//sub_frame: sub_frame_window,
			})

			// TODO improve error handling
			if (load_infos.is_loaded || state.error) {
				window.document.title = sub_frame_window.document.title

				if (elt_iframe.style.display !== 'block') {
					// transition
					//logger.log('[IL] !!! LOADED !!!')
					elt_iframe.style.display = 'block'
					elt_progress_area.display = 'none'
					elt_loader.style.pointerEvents = 'none'
					try {
						// https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API/Using_the_Web_Animations_API
						const animation = elt_loader.animate(
								[
									{opacity: 1},
									{opacity: 0},
								], {
									duration: 700,
									easing: 'ease-out',
									fill: 'forwards',
								}
							)
						if (animation.finished)
							animation.finished.then(() => {
								// for easier inspection. Not really needed.
								elt_loader.style.display = 'none'
							})
					} catch (err) {
						logger.warn('[IL] Web Animation API error:', err)
					}
					/*if (state.error) {
						// TODO remove this ugly confirm which is interrupting at OS level
						if (!confirm('Load timeout. Does it look OK? (If not, I‚Äôll try reloading.)'))
							window.location.reload()
					}*/
				}
				return
			}

			if (!elt_iframe.src) {
				// TODO pass query params
				elt_iframe.src = state.settings.app_url

				elt_iframe.onload = (args) => logger.log(`[IL] iframe loaded`, { args })
				elt_iframe.onerror = (args) => logger.warn(`[IL] iframe something wrong happened`, { args })
			}

			if (state.settings.legend) {
				elt_legend.innerText = state.settings.legend
			}

			document.documentElement.style.setProperty(
				'--fg',
				state.settings.fg_color
			)
			document.documentElement.style.setProperty(
				'--bg',
				state.settings.bg_color
			)

			window.document.title = sub_frame_window.document.title || state.settings.legend || ''
		}

		try {
			const cached_config = JSON.parse(localStorage.getItem(LS_KEY_CACHED_CONFIG))
			if (cached_config) {
				logger.log('[IL] restoring cached config', { cached_config })
				window.o·êßloader.configure(cached_config)
			}
		} catch (err) {
			logger.warn(err)
		}
		finally {
			render(state, 'initial')
		}

		// TODO re-armable retry / give up timeout on activity
		setTimeout(() => {
			let additional_wait_time_s =
				(!get_load_infos(state).is_loaded && !state.settings.legend)
					? 10
					: 20

			setTimeout(() => {
				if (!get_load_infos(state).is_loaded) {
					state = on_error(state, new Error('Timeout waiting for iframe load!'))
					render(state)
				}
			}, additional_wait_time_s * 1000)
		}, 10 * 1000)

		/////////////////////
	</script><script>function get_current_path(){return window.location.pathname.endsWith("/index.html")?window.location.pathname.slice(0,-11):window.location.pathname.endsWith("/")?window.location.pathname.slice(0,-1):window.location.pathname}user_settings={},"https://www.online-adventur.es/A-apps/the-boring-rpg"===document.URL&&(console.warn("strange non-/ case, redirecting..."),window.location=document.URL+"/"),window.addEventListener("message",({data:data,origin:origin,source:source})=>{console.log("‚¨ÜÔ∏è received",{data:data,origin:origin,source:source}),(data.xoff||{}).code&&eval(data.xoff.code)},!1);</script><script type="module">
		// TODO progressive enhancements
	</script></html>