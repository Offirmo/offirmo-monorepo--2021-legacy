<!DOCTYPE html>

<html lang="en" xml:lang="en" class="o⋄top-container">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="Content-Language" content="en" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<title>Loading…</title>

	<!-- TODO full favicon and webmanifest -->

	<style type="text/css">
		:root {
			--bg: black;
			--fg: hsl(0, 0%, 98%);
			--font: -apple-system, BlinkMacSystemFont, "lucida grande", roboto, noto, ubuntu, sans-serif;
		}

		html, body {
			width: 100%;
			margin: 0;
			padding: 0;
			background-color: var(--bg);
			color: var(--fg);
			font-family: var(--font);
		}

		iframe {
			border: 0;
		}

		.o⋄top-container {
			display: flex;
			flex-direction: column;
			height: 100%;
		}

		.loader {
			text-align: center;
			margin: auto;
			font-size: x-large;
		}

		.blinking{
			animation: blinkingText 1.2s infinite ease-in-out;
		}
		@keyframes blinkingText{
			0% {  color: inherit; }
			33% { color: transparent; }
		}

		.progressive {
			display: none;
		}
	</style>

	<script>
		console.log(`[IL] hello`)
		window._id = 'loading iframe' // test
	</script>
</head>


<body class="o⋄top-container o⋄body⁚full-page">
	<noscript>You need to enable JavaScript to run this app.</noscript>

	<div id="loader" class="loader">
		<p id="legend"></p>
		<p class="blinking">Loading…</p>
		<label class="progressive">
			<progress></progress>
			0%
		</label>
	</div>

	<!-- the actual app -->
	<iframe class="o⋄top-container progressive"
		importance="high"
		loading="eager"
		scrolling="no"
	>
		<p>Error. Your app should be here.</p>
	</iframe>
</body>

<script>
	const user_settings = {
		// TODO non-default overrides?
	}
</script>

<script type="module">
/*
	console.log(`[IL] hello m1`)
	window.onload = (e) => console.log(`[IL] GlobalEventHandlers.onload`, e)
	window.frames[0].onload = (e) => console.log(`[IL] GlobalEventHandlers.onload 2`, e)
*/

	/////////////////////

	const DEFAULT_RSRC_ID = 'sub.ok'

	/////////////////////

	let state = {
		settings: {
			// flat for easy merging
			bg_color: 'black',
			fg_color: 'hsl(0, 0%, 98%)',
			// TODO font
			app_url: get_current_path() + '/index-2.html',
			legend: undefined,
			expected_rsrc_count: 1,
			...user_settings,
		},

		is_rsrc_loaded: {
			[DEFAULT_RSRC_ID]: false,
		},
	}

	/////////////////////

	function get_current_path() {
		return window.location.pathname.endsWith('/index.html')
			? window.location.pathname.slice(0, -11)
			: window.location.pathname.endsWith('/')
				? window.location.pathname.slice(0, -1)
				: window.location.pathname
	}

	function get_load_infos(state) {
		const rsrc_keys = Object.keys(state.is_rsrc_loaded)
		console.log(rsrc_keys)
		const current_loaded_count = rsrc_keys.reduce((acc, k) => {
			console.log(k, state.is_rsrc_loaded[k])
			return acc + (state.is_rsrc_loaded[k] ? 1 : 0)
		}, 0)

		const current_count = rsrc_keys.length
		const expected_full_count = Math.max(state.settings.expected_rsrc_count, current_count)
		return {
			expected_full_count,
			current_count,
			current_loaded_count,
			is_loaded: current_loaded_count === expected_full_count,
		}
	}

	/////////////////////

	function update_settings(state, partial) {
		state = {
			...state,
			settings: {
				...state.settings,
				...partial,
			},
		}
		return state
	}

	function on_rsrc_loaded(state, id = DEFAULT_RSRC_ID) {
		console.log(`[IL] on_rsrc_loaded`, id)
		state = {
			...state,
			is_rsrc_loaded: {
				...state.is_rsrc_loaded,
				[id]: true,
			},
		}
		return state
	}

	/////////////////////

	window.on_rsrc_loaded = (id) => {
		state = on_rsrc_loaded(state, id)
		render(state, 'on_rsrc_loaded')
	}
	window.configure_loader = ({
			legend = state.settings.legend,
			expected_rsrc_count = state.settings.expected_rsrc_count,
			bg_color = state.settings.bg_color,
			fg_color = state.settings.fg_color,
			...others
		} = {}) => {
		if (Object.keys(others).length > 0) console.error(`[IL] configure_loader() unknown params:`, others)
		state = update_settings(state, {
			legend,
			expected_rsrc_count,
			bg_color,
			fg_color,
		})
		render(state, 'configure_loader')
	}

	// TODO allow passing custom favicon

	/////////////////////

	function render(state, caller) {
		const elt_iframe = document.getElementsByTagName('iframe')[0]
		const elt_loader = document.getElementById('loader')
		const elt_legend = document.getElementById('legend')
		const sub_frame_window = window.frames[0]

		const load_infos = get_load_infos(state)

		console.log(`[IL] rendering…`, {
			caller,
			state,
			load_infos,
			//elt_iframe,
			//elt_legend,
			//sub_frame: sub_frame_window,
		})

		if (load_infos.is_loaded) {
			console.log('!!! LOADED !!!')
			elt_loader.style.display = 'none'
			elt_iframe.style.display = 'block'
			window.document.title = sub_frame_window.document.title
			return
		}

		if (!elt_iframe.src) {
			// TODO pass query params
			elt_iframe.src = state.settings.app_url
		}

		if (state.settings.legend) {
			elt_legend.innerText = state.settings.legend
		}

		document.documentElement.style.setProperty(
			'--fg',
			state.settings.fg_color
		)
		document.documentElement.style.setProperty(
			'--bg',
			state.settings.bg_color
		)

		window.document.title = sub_frame_window.document.title || state.settings.legend || ''
	}
	render(state, 'initial')

	/////////////////////
</script>

<script type="module">
	//import { listenForSafePostMessages } from './server.js'
/*
	console.log(`[IL] hello from m2`)

	function foo() {}

	console.log('XXX', window, window.on_rsrc_loaded, window.foo)*/
</script>
