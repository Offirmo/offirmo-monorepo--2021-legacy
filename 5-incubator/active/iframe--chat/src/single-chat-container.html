<!DOCTYPE html>
<html lang="en" class="oâ‹„top-container">
	<head>
		<meta charset="UTF-8">
		<title>single-chat-container.html</title>

		<style>
			@import "../../../../3-advanced--browser/view-css/src/style--containers.css";
			@import "../../../../3-advanced--browser/view-css/src/style--debug.css";

			:root {
				--bg: transparent;
			}

			body {
				margin: 0;
				background-color: var(--bg);
			}
			.oâ‹„top-container {
				border-width: 1px;
			}
		</style>
		<script>
			console.log('Hello from single-chat-container.html head')
			// TODO attach error handlers
			// TODO read query params and pass them to the div
		</script>
	</head>

	<body class="oâ‹„top-container">
		<script>
			const LIB = '@offirmo/ðŸ–¼ðŸ’¬/ðŸ“¦tlk.io'

			// alter/fix the defaults above according to params
			console.log(`[${LIB}] Hello from single-chat-container.html body`, {
				'window.location': window.location,
				'document.referrer': document.referrer,
				searchParams: new URLSearchParams(window.location.search),
			})

			const state = (() => {
				const searchParams = new URLSearchParams(window.location.search)

				const id       = searchParams.get('channel_id') || location.hostname // TODO referrer
				const theme    = searchParams.get('theme')      || 'night'
				const nickname = searchParams.get('nickname')   || 'anonymousâµ§' + (() => {
					// https://michalzalecki.com/generate-unique-id-in-the-browser-without-a-library/
					let anon_uuid = crypto.getRandomValues(new Uint32Array(1))[0].toString(16)

					try { // defensive!
						const LS_KEY = `@offirmo-private/iframe--chat/anon_uuid`
						let candidate = localStorage.getItem(LS_KEY)
						if (candidate && candidate.length === anon_uuid.length)
							return candidate
						localStorage.setItem(LS_KEY, anon_uuid)
					} catch (e) { /* swallow */ }

					return anon_uuid
				})()
				const bg_color = searchParams.get('bg_color')   || ({
					'day':     '#f4f3f1',
					'night':   '#26282c',
					'pop':     '#f9eced',
					'minimal': 'transparent',
				}[theme] ?? 'transparent')
				const css_overrides_url = searchParams.get('css_overrides_url') || (location.origin + '/tlk.io_overrides.css') // NOTE: should be absolute

				return {
					id,
					theme,
					bg_color,
					nickname,
					css_overrides_url,
				}
			})()

			function render() {
				console.log(`[${LIB}] renderingâ€¦`, state)
				const div = document.createElement('div')

				document.documentElement.style.setProperty( '--bg', state.bg_color )

				div.id = 'tlkio' // mandatory for the tlk.io script to work
				div.className = 'oâ‹„top-container'
				div.setAttribute('data-channel', state.id)
				div.style = 'width:100%;height:100%;' // TODO max-width:762px;
				div.setAttribute('data-theme', 'theme--' + state.theme)
				if (state.nickname)
					div.setAttribute('data-nickname', state.nickname)
				if (state.css_overrides_url)
					div.setAttribute('data-custom-css', state.css_overrides_url)

				document.body.appendChild(div)

				// add script
				// https://stackoverflow.com/a/26478358/587407
				const script = document.createElement('script')
				script.type = 'text/javascript'
				script.async = true
				script.importance = 'low'
				script.src = 'https://tlk.io/embed.js'
				document.body.appendChild(script)
			}
			render()
		</script>
	</body>
</html>
