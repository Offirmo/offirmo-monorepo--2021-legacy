!function(e,t){for(var r in t)e[r]=t[r]}(exports,function(e){var t={};function r(n){if(t[n])return t[n].exports;var u=t[n]={i:n,l:!1,exports:{}};return e[n].call(u.exports,u,u.exports,r),u.l=!0,u.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var u in e)r.d(n,u,function(t){return e[t]}.bind(null,u));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=16)}([function(e,t){e.exports=require("tslib")},,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),u=n.__importDefault(r(18)),o=n.__importDefault(r(19));t.get_db=u.default(()=>o.default({client:"pg",connection:process.env.SECRET_DATABASE_URL||"postgres://postgres:@127.0.0.1:32768/postgres",debug:!0,pool:{min:1,max:1}})),t.default=t.get_db},,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TABLE_USERS="users",t.TABLE_NETLIFY_USERS="users__netlify",t.DEFAULT_ROLES=[],t.DEFAULT_CALLED="anonymous"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(2));async function u(e,t=n.default()){const[r]=await t("users").insert(e).returning("id");return r}async function o(e,t=n.default()){await t("users__netlify").insert(e)}t.create_user=u,t.create_netlify_user=o,t.create_user_through_netlify=async function(e,t){return n.default().transaction(async r=>{const n=await u(t,r);return o({...t,user_id:n,own_id:e},r).then(r.commit).then(()=>{}).catch(e=>{throw r.rollback(e),e})})}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(2)),u=r(4);t.get_full_user_through_netlify=async function(e){const t=await n.default().select(n.default().raw('row_to_json("users__netlify".*) AS "netlify_user", row_to_json("users".*) AS "user"')).from("users").fullOuterJoin("users__netlify",{"users.id":"users__netlify.user_id"}).where("users__netlify.own_id",e);if(!t||!t.length)return null;const r=t[0].user,o=t[0].netlify_user;return{created_at:r.created_at,updated_at:r.updated_at,id:r.id,called:r.called||o.called||u.DEFAULT_CALLED,email:r.email||o.email,avatar_url:r.avatar_url||o.avatar_url,roles:Array.from(new Set([...r.roles,...o.roles,...u.DEFAULT_ROLES]))}}},,,,,,,,,,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.handler=async(e,t)=>{if(!t.clientContext)throw new Error("No/bad/outdated token!");const n=t.clientContext;if(!n.user)throw new Error("No/bad/outdated token!");const{email:u,sub:o,app_metadata:{provider:l,roles:s},user_metadata:{avatar_url:a,full_name:i}}=n.user,_={from_context:{netlify_id:o,email:u,provider:l,roles:s,avatar_url:a,full_name:i}};try{const e={called:i,avatar_url:a,email:u,roles:s||[]};_.db_query={netlify_id:o,data:e};const{ensure_user_through_netlify:t}=r(17);_.db_result=await t(o,e)}catch(e){_.db_result=`Err: ${e.message}!`}return console.log(_),{statusCode:200,body:JSON.stringify(_,null,2)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);n.__exportStar(r(2),t),n.__exportStar(r(20),t)},function(e,t,r){"use strict";function n(e){let t,r=!1;return function(){return r||(t=e(),r=!0),t}}r.r(t),r.d(t,"tiny_singleton",(function(){return n})),t.default=n},function(e,t){e.exports=require("knex")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);n.__exportStar(r(4),t),n.__exportStar(r(5),t),n.__exportStar(r(6),t),n.__exportStar(r(21),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(22)),u=r(5),o=r(6);t.ensure_user_through_netlify=async function(e,t){let r=await o.get_full_user_through_netlify(e);return r&&console.log("get_full_user_through_netlify #1",{result:r}),r||(console.log("not found, creating a new user..."),await u.create_user_through_netlify(e,t),r=await o.get_full_user_through_netlify(e),console.log("get_full_user_through_netlify #2",{result:r})),n.default(r),r}},function(e,t){e.exports=require("tiny-invariant")}]));